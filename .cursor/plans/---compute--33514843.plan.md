<!-- 33514843-89e0-4eba-b801-ab2a34a3b66b 0102e87a-0702-4000-867c-f73d80acec90 -->
# 修改 RAGTruth Task 指标计算

## 目标

在 `ragtruth_task.py` 的 `compute_metrics` 方法中集成 span-level 指标计算，使用 `span_utils.py` 中的 `calculate_span_f1` 函数。

## 实现步骤

### 1. 添加导入语句

在 `ragtruth_task.py` 文件头部添加：

```python
from ..metrics.span_utils import calculate_span_f1
```

### 2. 修改 compute_metrics 方法

在现有的 `compute_metrics` 方法中：

#### 2.1 计算每个样本的指标

- 遍历所有成功的结果（`ok=True`）
- 提取 `hallucination_spans`（ground truth）和 `predicted_hallucination_spans`（predicted）
- 调用 `calculate_span_f1` 计算每个样本的 precision, recall, f1

#### 2.2 计算整体平均指标

- 计算所有样本的 precision, recall, f1 的平均值
- 添加到返回的 metrics 字典中

#### 2.3 按任务类型计算指标

- 在现有的 `task_stats` 循环中，为每个任务类型计算平均 precision, recall, f1
- 将指标添加到各任务类型的统计中

### 3. 更新返回的 metrics 结构

新增以下字段：

- `precision_mean`: 整体平均精确率
- `recall_mean`: 整体平均召回率  
- `f1_mean`: 整体平均F1分数
- `by_task[task_type]` 中新增各任务的 `precision_mean`, `recall_mean`, `f1_mean`

## 关键实现点

- 只对解析成功的样本（`ok=True`）计算指标
- 处理空 spans 的情况（根据 `calculate_span_f1` 的定义）
- 保持向后兼容性，不影响现有指标的计算
- 使用 `dropna()` 处理可能的无效数据

### To-dos

- [ ] 也有一个整体的不区分任务的 metrics 的计算
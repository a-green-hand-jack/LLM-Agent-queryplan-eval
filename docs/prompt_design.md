# QueryPlan-LLM Prompt 工程蓝图

## 项目目标与产出

### 任务定义
- **核心任务**：从查询（query）与对话历史中稳定抽取结构化 Plan
- **输出字段**：`(domain, sub, is_personal, time, food)`
- **输出格式**：JSON 列表，支持多组 Plan
- **约束**：清晰的系统提示词，固定输入格式，压缩随意发挥空间

## Prompt 框架与关键规则

### 1. 拒答策略（Refusal Policy）

**越界情况**（返回仅 `refuse` 无其他字段）：
- 非运动健康领域
- 涉医诊断与处方
- 设备控制与选购
- 违法违规

### 2. Domain 与 Sub 字段

#### 枚举定义
```
domain:
  - health     # 健康
  - exercise   # 运动

sub (health):
  - sleep          # 睡眠
  - diet           # 饮食
  - vitals         # 生命体征
  - medical_check  # 体检
  - other          # 其他

sub (exercise):
  - running           # 跑步
  - cycling           # 骑行
  - swimming          # 游泳
  - badminton         # 羽毛球
  - basketball        # 篮球
  - soccer            # 足球
  - tennis            # 网球
  - yoga              # 瑜伽
  - gym               # 健身房锻炼
  - walking           # 散步
  - hiking            # 登山
  - stretching        # 拉伸
  - other             # 其他
```

#### 默认映射规则
- 无明确场景时，health 默认落到 `medical_check`（微体检），exercise 默认落到 `other`

### 3. is_personal 字段

- **True**：面向"本人"的查询
- **False**：指向特定人群（孕妇、朋友、群体等）或 `domain=other` 时

#### 重要约束
- 当 `is_personal=false` 时，不抽取 `time` 和 `food` 字段

### 4. Time 字段抽取规则

#### 时间格式
- 标准格式：`yyyy年mm月dd日` 或起点:止点
- 次数类：`倒数第x次`、`前x次`
- **不支持小时粒度**

#### 特殊处理规则

##### 未给起点的"至今"查询
- 默认起点：两年前的今天
- 未来时间：一律截断到今天

##### 精确区间
```
本周/月/季/年         → 从周一/月初/季初到今天
这X周/这X月           → 完整自然周/月
X周/月前              → 完整自然周/月
同期                  → 按日/周一对齐
```

##### 模糊时间
```
最近                  → 近7天
近X周/月              → 映射到具体日期
这几周/月             → 映射到具体日期
月底溢出              → 见具体规则
```

### 5. Food 字段抽取规则

- **只抽具体食物名**（如：苹果、鸡蛋）
- **不抽营养成分**（如：蛋白质、维生素）
- **不抽泛类名**（如：水果、蔬菜）

## 场景特例与多轮对话

### 睡眠特例（核心复杂性）

#### 记录日期基准
- **睡眠记录的基准日期**：起床日期（不是睡眠日期）

#### 涉及晚上/昨晚/今晚的处理
- 需要**顺延到第二天记录**
- 例如："昨晚睡得怎么样" → 记录为今天的睡眠数据

#### 单轮默认映射
- "昨天睡得怎么样？" → 默认映射到**今天**（昨晚-今晨）
- **Summary 阶段**需提示所指日期

#### 多轮上下文依赖
- 上一轮已回答"今天的睡眠" → 本轮问"昨天"时，改抽**昨天**

### 非睡眠场景
- 以**当天**为记录日期

### 多轮对话策略

#### 优先级规则
- 优先最近一轮结果
- 支持追问类型：
  1. 其他周期
  2. 其他指标
  3. 澄清

#### 已知 Corner Case
- **第一轮**按"跑步"时间抽取
- **第二轮**改问"羽毛球"时
- **必须重新提示时间字段**，不能沿用跑步的时间

## 数据构造与评测

### 合成管线

```
场景指标 × 时间描述 → 大模型生成 query → 配随机日期 → 代码回填
                                              ↓
                                      12万真实 query 种子
                                              ↓
                    教师模型 / 产品数据蒸馏 → 高质量 SFT 数据集
```

### 关键难点与质检

| 难点 | 表现形式 | 对策 |
|------|---------|------|
| 时间偏差 | 上上个月 → 上个月、最近X天计算错误 | 单元测试用例 |
| 睡眠映射 | 昨天/昨晚映射错误 | 专项对抗样例 |
| 非睡眠误判 | 其他领域误认为今天 | 场景区分测试 |

### 评估指标

#### 覆盖度与多样性
- Query 覆盖度
- 场景多样性指数

#### 复杂度与一致性
- 复杂度评分
- 数值计算一致性（±1天内）

#### 核心指标
- **场景正确率**
- **时间正确率**
- **Schema 成功率**

## 实现与资源约束

### 基线模型与部署

| 指标 | 配置 |
|------|------|
| 模型 | Qwen3-14B / QwQ-32B |
| 硬件 | Ascend（华为芯片） |
| 框架 | Llama-factory |
| 微调策略 | LoRA / 全参 |
| 学习方案 | 两阶段微调 + 强化学习 |

### Prompt 设计约束

- **短而刚性**：压缩提示词长度，增强确定性
- **可枚举校验**：所有关键字段可通过枚举验证
- **降低推理延迟**：优化令牌生成速度
- **减少幻觉**：强约束系统提示，使用结构化生成（Outlines）

## 总结

本项目以**强约束系统提示词 + 规则化时间/场景抽取 + 睡眠特例与多轮显式策略**为核心，通过**大规模种子×规则×蒸馏数据工程**保证一致性与可测性，最终实现高稳定、可部署的查询计划抽取系统。
